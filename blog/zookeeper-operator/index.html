<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  <title>Zookeeper operator 实战 | 云原生社区</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Zookeeper作为最新完成 operator 化的组件，除了可以快速部署以外，还实现了 Operator 对 scale up/down 的进度干预，控制 rolling 的重启顺序，感知组件实际运行状态等，具体实现请阅读对于相关章节。">
  
  <meta name="author" content="Cloud Native Community">
  <meta name="generator" content="Hugo 0.55.5" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">

  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
</head>
<body>
<!-- header -->
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="Cloud Native Community"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item">
              <a class="nav-link" href="/about">关于</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/blog">博客</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/team">团队</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contact">联系</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
          </ul>

          
          

          
          <!-- search -->
          <div class="search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->


<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3">Zookeeper operator 实战</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">Zookeeper作为最新完成 operator 化的组件，除了可以快速部署以外，还实现了 Operator 对 scale up/down 的进度干预，控制 rolling 的重启顺序，感知组件实际运行状态等，具体实现请阅读对于相关章节。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->


<!-- blog details -->
<section class="section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='\/images\/blog\/zookeeper-operator-1.png'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type">Operator</div>
        </div>
        <div class="card-meta text-uppercase mb-2">作者  <strong class="text-dark"><a href="https://github.com/Ghostbaby">朱慧君</a></strong>
          
            发表于 <strong class="text-dark">2020年6月8日</strong></div>
        <hr>
        <div class="content">
          

<h2 id="导言">导言</h2>

<p>2018年 kubecon 大会上，阿里的陈俊大佬分享 Node-operator 的主题让我印象深刻，回来之后开始着手研究 Operator。正好当时老板希望能够将公司正在使用的 Nosql 组件容器化，顺势给老板安利一波 Operator 的思想。随后以 opentsdb 的容器为开端，后续完成一系列组件容器化，一路走来不断学习和借鉴其他 operator 的先进经验。Zookeeper作为最新完成 operator 化的组件，除了可以快速部署以外，还实现了 Operator 对 scale up/down 的进度干预，控制 rolling 的重启顺序，感知组件实际运行状态等，具体实现请阅读对于相关章节。</p>

<h2 id="功能需求">功能需求</h2>

<p>目前 operator 主要实现如下功能：
- 快速部署
- 安全伸缩容
- 自动化监控
- 故障自愈
- 可视化操作</p>

<h2 id="crd">CRD</h2>

<p>Operator 设计第一步是定义声明式接口的 Item，spec 主要包含节点资源、监控组件、副本数、持久化存储。</p>

<pre><code class="language-yaml">apiVersion: database.ymm-inc.com/v1beta1
kind: ZooKeeper
metadata:
  name: zookeeper-sample
spec:
  version: v3.5.6
  cluster:
    name: test
    resources:
      requests:
        cpu: 1000m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 2Gi
    exporter:
      exporter: true
      exporterImage: harbor.ymmoa.com/monitoring/zookeeper_exporter
      exporterVersion: v3.5.6
      disableExporterProbes: false
    nodeCount: 3
    storage:
      size: 100Gi
</code></pre>

<h2 id="架构图">架构图</h2>

<p>Operator 主要包含：Deploy、Monitor、Scale 三个大模块。
- Deploy：主要用于生成和创建 Statefulset、Service、ConfigMap、PV 等原生资源，用于快速部署 zookeeper 集群。
- Monitor：主要用于生成和创建 ServiceMonitor、PrometheusRule 资源，用于自动化注册 target、添加告警策略，实现对集群的监控和告警。
- Scale：主要用于把控扩缩容以及滚动升级的进度，确保以最少的主从切换完成重启。</p>

<p><img src="/images/blog/zookeeper-operator-2.png" alt="架构图" /></p>

<h2 id="具体方案">具体方案</h2>

<h3 id="快速部署">快速部署</h3>

<h4 id="基本知识">基本知识</h4>

<ul>
<li><p>Kubernetes Labels</p>

<ul>
<li>Labels：是一对 key/value，被关联到特定对象上，标签一般用来表示同一类资源，用来划分特定的对象，一个对象可以有多个标签，但是，key 值必须是唯一的。这里我们将在 list-watch 的时候用这个 labels 进行过滤，从所有的 Kubernetes event 中过滤出符合特定 label 的 event，用来触发 operator 的主流程。</li>
</ul></li>

<li><p>Kubernetes Informer</p>

<ul>
<li><p>watch：可以是 Kubernetes 内建的资源或者是自定义的资源。当 reflector 通过 watch API 接收到有关新资源实例存在的通知时，它使用相应的列表 API 获取新创建的对象，并将其放入 watchHandler 函数内的 Delta Fifo 队列中。</p></li>

<li><p>Informer：informer 从 Delta Fifo 队列中弹出对象。执行此操作的功能是 processLoop。Base controller 的作用是保存对象以供以后检索，并调用我们的控制器将对象传递给它。</p></li>

<li><p>Indexer：索引器提供对象的索引功能。典型的索引用例是基于对象标签创建索引。 Indexer 可以根据多个索引函数维护索引。Indexer 使用线程安全的数据存储来存储对象及其键。 在 Store 中定义了一个名为 MetaNamespaceKeyFunc 的默认函数，该函数生成对象的键作为该对象的 <namespace> / <name> 组合。</p></li>
</ul></li>
</ul>

<h4 id="labels">Labels</h4>

<pre><code class="language-yaml">labels:
  app: zookeeper
  app.kubernetes.io/instance: zookeeper-sample
  app.kubernetes.io/managed-by: zookeeper-operator
  app.kubernetes.io/name: zookeeper
  app.kubernetes.io/part-of: zookeeper
  component: zookeeper
  zookeeper: zookeeper-sample
</code></pre>

<h4 id="节点部署">节点部署</h4>

<h5 id="容器分类">容器分类</h5>

<ul>
<li>InitContainer

<ul>
<li>配置文件初始化容器，主要用于 zk config 文件复制到工作区域。</li>
</ul></li>
<li>Container

<ul>
<li>主进程容器</li>
<li>监控容器</li>
<li>Agent</li>
</ul></li>
</ul>

<h5 id="初始化容器">初始化容器</h5>

<blockquote>
<p>zoo.cfg.dynamic，这个文件同样以 configmap 方式挂入主容器，主要用于zk节点发现和注册，下面将详细介绍下这个zk 3.5之后的特性。</p>
</blockquote>

<ul>
<li><p>具体可以参考 ZooKeeper 动态重新配置</p>

<pre><code class="language-shell">server.1=zookeeper-sample-0.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181
server.2=zookeeper-sample-1.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181
server.3=zookeeper-sample-2.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181
server.4=zookeeper-sample-3.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181
server.5=zookeeper-sample-4.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181
</code></pre>

<ul>
<li>更新目录权限
&gt;设置 data 和 logs 目录的权限，确保 zk 能够正常启动。
```shell script
echo &ldquo;chowning /data to zookeeper:zookeeper&rdquo;
chown -v zookeeper:zookeeper /data</li>
</ul>

<p>echo &ldquo;chowning /logs to zookeeper:zookeeper&rdquo;
chown -v zookeeper:zookeeper /logs
```</p></li>
</ul>

<h5 id="主进程容器">主进程容器</h5>

<ul>
<li>环境变量
&gt; POD_IP、POD_NAME，主要将 node 的 pod ip 和名称传到 pod 内部，方便容器内部调用。
&gt;
&gt;ZK_SERVER_HEAP，这变量为限制 zk 启动 heapsize 大小，由 operator 根据 request 内部大小设置，zk启动会读取这个变量。</li>
</ul>

<pre><code class="language-yaml">- name: POD_IP
  valueFrom:
    fieldRef:
      apiVersion: v1
      fieldPath: status.podIP
- name: POD_NAME
  valueFrom:
    fieldRef:
      apiVersion: v1
      fieldPath: metadata.name
- name: ZK_SERVER_HEAP
  value: &quot;2048&quot;
- name: ZK_CLIENT_HEAP
  value: &quot;512&quot;
</code></pre>

<ul>
<li><p>Readiness探针
&gt; 主要通过 zk 客户端端口传入 ruok 命令，检查返回码，返回 imok 认为 zk node 已经准备完毕，zk node 将会被更新到上面说到的 zoo.cfg.dynamic 文件，zk cluster 将会自动发现该节点。</p>

<pre><code class="language-shell">ZK_CLIENT_PORT=${ZK_CLIENT_PORT:-2181}
OK=$(echo ruok | nc 127.0.0.1 $ZK_CLIENT_PORT)
if [ &quot;$OK&quot; == &quot;imok&quot; ]; then
exit 0
else
exit 1
fi
</code></pre>

<h5 id="监控容器">监控容器</h5>

<blockquote>
<p>github 项目（<a href="https://github.com/dabealu/zookeeper-exporter）">https://github.com/dabealu/zookeeper-exporter）</a>
exporter 跟随主进程一同启动，后续会介绍如何注册到 prometheus target 以及告警策略。</p>
</blockquote>

<h5 id="访问控制">访问控制</h5>

<ul>
<li>暴露端口
&gt;9114：该端口为 exporter 服务端口，通过 servicemonitor 注册 prometheus target 时将通过 labels 匹配该端口。
&gt;
&gt;1988：该端口为 zk-agent 服务端口，通过该接口 operator 可以查询到当前节点运行状态，后面会详解介绍。
&gt;
&gt;2181：该端口为 zk 客户端端口，该端口创建 Kubernetes headless 模式 svc，方便客户端一次获取所有节点 ip。
&gt;
&gt;3888：选举 leader 使用
&gt;
&gt;2888：集群内机器通讯使用（ Leader 监听此端口）
```yaml
ports:</li>
<li>name: client
port: 2181
protocol: TCP
targetPort: 2181</li>
<li>name: server
port: 2888
protocol: TCP
targetPort: 2888</li>
<li>name: leader-election
port: 3888
protocol: TCP
targetPort: 3888</li>
<li>name: http-metrics
port: 9114
protocol: TCP
targetPort: 9114</li>
<li>name: http-agent
port: 1988
protocol: TCP
targetPort: 1988
```</li>
</ul></li>

<li><p>暴露方式</p></li>
</ul>

<blockquote>
<p>这里主要 kubernetes service 的两种模式：Headless 和 Cluster</p>

<blockquote>
<p>Headless Services：简单而言就是，每次访问 headless service，kube-dns 将返回后端一组 ip，在我们这种场景下，即会返回 es 所有节点 ip 给客户端，再由客户端自己判断通过哪个 ip 访问 es 集群。</p>

<p>Cluster：这种模式是默认配置，创建此类 service 之后，将分配一个 cluster ip，这个 ip 类似 vip，每次访问这个 service name，kube-dns 将会随机返回一个节点 ip。</p>
</blockquote>

<p>operator 在创建 service 的时候，上面两种都会创建，headless 类型主要给 kubernetes 内部应用访问，cluster 类型主要通过 NodePort 暴露给外部应用访问。</p>
</blockquote>

<h5 id="配置信息">配置信息</h5>

<ul>
<li><p>配置文件</p>

<pre><code class="language-textmate">autopurge.purgeInterval=24
autopurge.snapRetainCount=20
initLimit=10
syncLimit=5
skipACL=yes
maxClientCnxns=300
4lw.commands.whitelist=cons, envi, conf, crst, srvr, stat, mntr, ruok
tickTime=2000
dataDir=/data
dataLogDir=/logs
reconfigEnabled=true
standaloneEnabled=false
dynamicConfigFile=/conf/zoo.cfg.dynamic.c00000002
</code></pre>

<h5 id="数据存储">数据存储</h5>

<ul>
<li>PersistentVolume
&gt; StorageClass PROVISIONER: diskplugin.csi.alibabacloud.com，阿里云CSI插件实现了 Kubernetes 平台使用阿里云云存储卷的生命周期管理，支持动态创建、挂载、使用云数据卷。 当前的 CSI 实现基于kubernetes 1.14以上的版本。
&gt;
&gt;云盘 CSI 插件支持动态创建云盘数据卷、挂载数据卷。云盘是一种块存储类型，只能同时被一个负载使用(ReadWriteOnce)。
&gt;
&gt;operator 会将 CRD 中配置的 pvc 信息，透传到 sts 中去，并挂载到 zk data 目录下 。</li>
</ul>

<h3 id="自动化监控">自动化监控</h3>

<h4 id="监控注册">监控注册</h4>

<h5 id="servicemonitor">ServiceMonitor</h5>

<p><code>selector.matchLabels</code>：这里通过 zookeeper: zookeeper-sample 来匹配 service。</p>

<p><code>port: http-metrics</code>：这里通过匹配 service 中到 port name 来注册到 prometheus target。</p>

<p>operator 调用 prometheus-operator client 完成 ServiceMonitor 资源的创建，实现新建zk集群自动注册到prometheus的功能。</p>

<pre><code class="language-yaml">apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
labels:
app: zookeeper
app.kubernetes.io/instance: zookeeper-sample
app.kubernetes.io/managed-by: zookeeper-operator
app.kubernetes.io/name: zookeeper
app.kubernetes.io/part-of: zookeeper
component: zookeeper
zookeeper: zookeeper-sample
name: zookeeper-sample
namespace: default
spec:
endpoints:
- interval: 30s
port: http-metrics
namespaceSelector: {}
selector:
matchLabels:
  zookeeper: zookeeper-sample
</code></pre></li>
</ul>

<h5 id="prometheusrule">PrometheusRule</h5>

<p>operator 调用 prometheus-operator client 完成 PrometheusRule 资源的创建，实现将告警策略自动注册到 prometheus。</p>

<p>告警策略中的 dingtalkRobot 标签，主要用来重定向告警信息到指定钉钉群中，这里可以添加多个钉钉群机器人。</p>

<h3 id="安全伸缩容">安全伸缩容</h3>

<h4 id="扩缩节点">扩缩节点</h4>

<ul>
<li><p>更新 Zookeeper CR 中 spec.cluster.nodeCount 配置。</p></li>

<li><p>触发 operator 主流程，判断期望副本数大于实际副本数继续流程，否则退出主流程。</p></li>

<li><p>更新 zk 集群 records，提交两种 record：</p>

<ul>
<li><p>Zookeeper upscale from 3 to 4.</p></li>

<li><p>Zookeeper Statefulset %s already update.</p></li>
</ul></li>

<li><p>更新 zk 集群 StatefulSet 资源，StatefulSet 控制器将会新建节点，zk 将新建节点加入集群中，数据将会自动做同步。</p></li>

<li><p>Reconfig 模块将从集群中添加或者剔除节点</p></li>
</ul>

<h4 id="扩资源">扩资源</h4>

<ul>
<li><p>更新 Zookeeper CR 中 spec.node.resources 配置。</p></li>

<li><p>如果zk节点数与期望节点数不一致，退出主流程，直到节点数一致，所有 pod 全部 ready。</p></li>

<li><p>通过节点数量检查之后，更新 StatefulSet 资源，由于我们这边 StatefulSet 设置的 RollingUpdate 策略为 OnDelete，即更新 StatefulSet 配置之后，StatefulSet 将不会主动重启节点以完成升级，需要我们自己手动去重启节点。</p></li>

<li><p>获取当前集群中节点角色，将 leader 节点放到最后重启，尽量减少集群不可用时间。</p></li>

<li><p>operator 比对 StatefulSet 和 pod resourceVersion值，如果不一致将节点加入到需要重启节点列表中。</p></li>

<li><p>operator 执行对节点如下检查项：</p>

<ul>
<li><p>当前重启中对节点是否超过 MaxUnavailable 值，目前 MaxUnavailable 值默认为1.</p></li>

<li><p>跳过节点状态为 Terminating 的节点。</p></li>
</ul></li>

<li><p>从重启节点中取一个节点，调用 kubernetes 接口，执行重启操作。</p></li>

<li><p>第一个节点重启完成之后，将 requeue 主流程，继续其他节点重启。</p></li>

<li><p>所有节点全部重启完成，滚动升级成功。</p></li>
</ul>

<h3 id="故障自愈">故障自愈</h3>

<h4 id="observer">Observer</h4>

<ul>
<li><p>operator 会为每一个创建的 zk 集群启动一个 observer，每个 observer 将会启动两个 goroutine：</p>

<ul>
<li><p>GetClusterStatus，获取 zk-agent /status 接口数据。</p></li>

<li><p>GetClusterUp，获取 /runok 接口数据。</p></li>
</ul></li>

<li><p>operator 将每10秒获取集群最新状态，包括集群状态、node 节点数、leader 节点等。</p></li>

<li><p>operator 获取到最新集群状态之后，将更新CR的 status 中，达到实时更新 CR 中 zk 集群状态的功能，效果如下图。</p>

<pre><code class="language-yaml">status:
availableNodes: 3
leaderNode: zookeeper-sample-1.zookeeper-sample.default.svc.cluster.local
</code></pre>

<ul>
<li>如果zk集群被销毁, operator 将调用 finalizers 方法停止 observer 协程。</li>
</ul>

<h4 id="触发主流程">触发主流程</h4>

<ul>
<li><p>operator 控制器在初始化的时候，将 watch 一个自定义的 event channel，等待 event 通过 channel 传递过来，触发主控流程执行。</p></li>

<li><p>observer 初始化的时候，创建一个 listeners 函数数组，用于 observer 状态刷新时候调用，每新建一个 zk 集群将加入一个 listener。</p></li>

<li><p>observer 执行一次，listeners 数组中的函数将会执行一次，获取最新各个 zk 集群的 health 状态。</p></li>

<li><p>listeners 数组的函数将判断，集群新状态与老状态是否一致，一致则返回 nil，否则进一步处理。</p></li>

<li><p>如果状态不一致将传值到 event channel，由 watch 消费以触发 operator 主控流程执行。</p></li>
</ul>

<h3 id="可视化操作">可视化操作</h3>

<p>可视化操作，主要实现一下功能：
- zk 集群的查询、创建、伸缩、资源调整
- 支持多 kubernetes 环境
- 支持集群监控展示</p>

<h4 id="多kubernetes环境">多kubernetes环境</h4>

<p>对于多 kubernetes 环境的支持，主要通过在每个环境部署 agent 组件，组件通过 rbac 进行授权，确保agent组件只能操作指定资源。将 agent 注册到管理平台，管理平台按照环境请求不同环境接口即可。</p>

<h4 id="接口列表">接口列表</h4>

<table>
<thead>
<tr>
<th>模式</th>
<th>接口</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>GET</td>
<td>/zookeeper/list</td>
<td>查询所有zookeeper集群信息</td>
<td></td>
</tr>

<tr>
<td>POST</td>
<td>/zookeeper/info</td>
<td>查询单个zookeeper集群信息</td>
<td></td>
</tr>

<tr>
<td>POST</td>
<td>/zookeeper/create</td>
<td>创建单个zookeeper集群</td>
<td></td>
</tr>

<tr>
<td>POST</td>
<td>/zookeeper/update</td>
<td>更新单个zookeeper集群</td>
<td></td>
</tr>

<tr>
<td>POST</td>
<td>/zookeeper/delete</td>
<td>销毁单个zookeeper集群</td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="参数校验">参数校验</h3>

<h4 id="admission-webhooks">Admission Webhooks</h4>

<ul>
<li>ValidatingWebhook：主要实现验证检测，即检查通过 kubernetes API client 提交到CR参数是否合法，如果不符合要求直接拒绝资源创建。检查项如下：</li>
<li>检查节点资源，request CPU/mem 是否小于 limit CPU/mem</li>
<li>MutatingWebhook：主要实现注入默认参数，即检查到提交参数缺少一些关键性参数，将由 webhook 补齐并注入到创建资源中。补全项如下：</li>
<li>节点资源限制，比如request cpu/mem和limit cpu/mem。</li>
<li>exporter配置，默认开启exporter，
<code>yaml
Exporter:              true,
ExporterImage:         &quot;harbor.ymmoa.com/monitoring/zookeeper_exporter&quot;,
ExporterVersion:       &quot;1.1.0&quot;,
DisableExporterProbes: false,
</code></li>
</ul></li>
</ul>

<h3 id="升级策略">升级策略</h3>

<p>StatefulSets 提供了多种升级策略：OnDelete，RollingUpdate，RollingUpdate with partition。</p>

<h4 id="ondelete的一般方法">OnDelete的一般方法</h4>

<p>使用 OnDelete，除非 Pod 的数量高于预期的副本数，否则 StatefulSet 控制器不会从 StatefulSet 中删除 Pod。</p>

<p>Operator 决定何时要删除 Pod。一旦删除，便会由 StatefulSet 控制器自动重新创建一个 Pod，该 Pod 具有相同的名称，但是最新的规范。</p>

<p>我们的操作员永远不会创建 Pod，但是当我们决定准备删除 Pod 时，它将负责 Pod 的删除。</p>

<p>当对 StatefulSet 进行修改时（例如，更改 Pod 资源限制），我们最终得到一个新的 revision（基于模板规范的哈希值）。</p>

<p>查看 StatefulSet 状态，我们可以获得当前的修订版（currentRevision: zookeeper-sample-7b889dd5b4），使用该修订版的容器的数量以及仍在使用旧修订版的容器的数量（updateRevision: zookeeper-sample-74597f9b9d）。</p>

<p>通过列出该 StatefulSet 中的 Pod，我们可以检查每个 Pod（metadata.labels[&ldquo;controller-revision-hash&rdquo;]: &ldquo;zookeeper-sample-7b889dd5b4&rdquo;）的当前版本。</p>

<h4 id="rollingupdate-partition-方法">RollingUpdate.Partition 方法</h4>

<p>使用此策略，我们定义了一个 partition 索引：这允许使用 StatefulSet 控制器替换序数高于此索引的 Pod。</p>

<p>例如，如果我们有一个带有5个副本的 StatefulSet：</p>

<ul>
<li>zookeeper-sample-0</li>
<li>zookeeper-sample-1</li>
<li>zookeeper-sample-2</li>
<li>zookeeper-sample-3</li>
<li>zookeeper-sample-4</li>
</ul>

<p>如果分区索引为3，则允许 StatefulSet 控制器自动删除然后重新创建 Pod zookeeper-sample-3 和 zookeeper-sample-4。</p>

<p>在此模式下，操作员永远不会删除 Pod。它所做的就是：
  - 当应添加新容器或应除去容器时，更新 StatefulSets 副本
  - 当应更换某些 Pod 时更新分区索引</p>

<p>要对上面的 StatefulSet 进行滚动升级，我们将从索引开始5，确保4可以安全地替换 Pod ，然后将索引更新为4。这将触发更换 Pod。</p>

<p>OnDelete 除了不显式删除 Pod 而是管理索引外，其他逻辑与适用相同。</p>

<h3 id="agent">Agent</h3>

<p>zk agent 作为 sidecar 伴随主容器一并启动，提供如下接口：
- status：返回宿主 zk 节点当前运行状态，参考 zk srvr 命令。
- runok：返回宿主 zk 节点是否正常运行且无错误，参考 zk ruok 命令。
- health：返回 agent 运行状态，用于 agent 的心跳检测。
- get：返回 zk 集群节点列表，查询 /zookeeper/config 文件。
- add：增加节点到 zk 集群中，主要依赖 zk reconfigure 特性，集群扩容时使用。
- del：从现有 zk 集群中删除某个节点，如果删除节点是主节点，会先做主节点切换，之后才会移除节点，集群缩容时使用。</p>

<h4 id="接口列表-1">接口列表</h4>

<table>
<thead>
<tr>
<th>模式</th>
<th>接口</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>GET</td>
<td>/status</td>
<td>getZkStatus</td>
<td></td>
</tr>

<tr>
<td>GET</td>
<td>/runok</td>
<td>getZkRunok</td>
<td></td>
</tr>

<tr>
<td>GET</td>
<td>/health</td>
<td>Health</td>
<td></td>
</tr>

<tr>
<td>GET</td>
<td>/get</td>
<td>getMember</td>
<td></td>
</tr>

<tr>
<td>POST</td>
<td>/add</td>
<td>addMember</td>
<td></td>
</tr>

<tr>
<td>POST</td>
<td>/del</td>
<td>delMember</td>
<td></td>
</tr>
</tbody>
</table>

<h4 id="get">GET</h4>

<p>/status, 获取当前 zk 节点运行状态，字段含义对照 <code>mntr</code> 查看信息，包括如下字段：</p>

<pre><code class="language-json">{
    &quot;Sent&quot;: 1617,
    &quot;Received&quot;: 1618,
    &quot;NodeCount&quot;: 5,
    &quot;MinLatency&quot;: 0,
    &quot;AvgLatency&quot;: 2,
    &quot;MaxLatency&quot;: 5,
    &quot;Connections&quot;: 1,
    &quot;Outstanding&quot;: 0,
    &quot;Epoch&quot;: 14,
    &quot;Counter&quot;: 82,
    &quot;BuildTime&quot;: &quot;2019-10-08T20:18:00Z&quot;,
    &quot;Mode&quot;: 2,                      //0表示Unknown，1代表Leader，2代表follower
    &quot;Version&quot;: &quot;3.5.6-c11b7e26bc554b8523dc929761dd28808913f091&quot;,
    &quot;Error&quot;: null
}
</code></pre>

<p>/runok，获取当前节点是否正常启动。</p>

<p>/health，获取 zk-agent 是否正常启动。</p>

<p>/get，获取当前 Reconfig 动态配置节点信息。</p>

<pre><code class="language-json">{
    &quot;record&quot;: &quot;server.1=zookeeper-sample-0.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181\nserver.2=zookeeper-sample-1.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181\nserver.3=zookeeper-sample-2.zookeeper-sample.default.svc.cluster.local:2888:3888:participant;0.0.0.0:2181\nversion=c00000002&quot;
}
</code></pre>

<h4 id="post">POST</h4>

<p>/add，获取客户端传入需要新增的节点信息，并更新到动态节点配置中。</p>

<p>/del，获取客户端传入需要删除到节点信息，并更新到动态节点配置中。传入值参考 add 接口格式。</p>

<h2 id="oam对接">OAM对接</h2>

<p><img src="/images/blog/oam.jpeg" alt="转自 孙健波 OAM 深入解读：OAM 为云原生应用带来哪些价值？" />
&gt; OAM 是一个专注于描述应用的标准规范。有了这个规范，应用描述就可以彻底与基础设施部署和管理应用的细节分开。这种关注点分离（Seperation of Conerns）的设计好处是非常明显的。</p>

<h3 id="应用组件-components">应用组件（Components）</h3>

<blockquote>
<p>组件（Components）：概念让平台架构师等能够将应用分解成成一个个可被复用的模块，这种模块化封装应用组成部分的思想，代表了一种构建安全、高可扩展性应用的最佳实践：通过一个完全分布式的架构模型，实现了应用组件描述和实现的解耦。</p>
</blockquote>

<p>按照应用组件的定义，对应到目前zk operator的快速部署模块上，部署模块主要生成和创建原生资源，完成容器化zk集群搭建，并持续维持声明式定义的集群终态。部署模块可以单独定义CRD, 比如 <code>workload.zookeeper.example.com</code>。</p>

<h3 id="应用运维特征-traits">应用运维特征（Traits）</h3>

<blockquote>
<p>运维特征（Traits）：它们描述了应用在具体部署环境中的运维特征，比如应用的水平扩展的策略和 Ingress 规则，这些特征对于应用的运维来说非常重要，但它们在不同的部署环境里却往往有着截然不同的实现方式。</p>
</blockquote>

<p>Traits则对应 zk operator 模块中的 伸缩、滚动升级两个模块，这两个模块可以抽出来定义为单独CRD，比如 <code>scale.zookeeper.example.com</code> 和 <code>rolling.zookeeper.example.com</code>。</p>

<h2 id="小结">小结</h2>

<p>目前 zk operator 的实现能力也仅仅实现 部署、伸缩、滚动升级、监控等能力，还有很多模块可以做，比如：备份、重置、迁移、调度策略、暂停等等。</p>

<h2 id="参考文档">参考文档</h2>

<ul>
<li> <a href="https://mp.weixin.qq.com/s/O94sUDPlEcNKvfbQyrb8-w">阿里云携手微软与 Crossplane 社区发布 OAM Kubernetes 标准实现与核心依赖库</a></li>
<li><a href="https://www.infoq.cn/article/gizNAvObXREqfvWMTvYt">OAM 正式开源：全球首个云原生应用标准定义与架构模型</a></li>
</ul>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/zookeeper"> 
            Zookeeper</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/operator"> , 
            Operator</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/oam"> , 
            OAM</a>
            
          </ul>
        </div>
        
        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          const gitalk = new Gitalk({
            clientID: '0f001988910adcfadfb7',
            clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
            repo: 'cloudnativeto.github.io',
            owner: 'cloudnativeto',
            admin: ['rootsongjc'],
            id: location.pathname, 
            distractionFreeMode: false 
          });
          (function() {
            if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
              document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
              return;
            }
            gitalk.render('gitalk-container');
          })();
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
  <!-- latest post -->
  <div class="bg-white px-4 py-5 box-shadow mb-5">
    <h4 class="mb-4">最新文章</h4>
    <!-- post-item -->
    
    <div class="media border-bottom border-color pb-3 mb-3">
      <a href="/blog/flame-graph/"><img class="mr-3 post-thumb-sm" src="/images/blog/flamegraph.png"></a>
      <div class="media-body">
        <a href="/blog/flame-graph/">
          <h5 class="mt-0">性能调优利器--火焰图</h5>
        </a>
        2020年6月17日
      </div>
    </div>
    
    <div class="media border-bottom border-color pb-3 mb-3">
      <a href="/blog/envoy-wasm/"><img class="mr-3 post-thumb-sm" src="/images/blog/envoy-wasm.png"></a>
      <div class="media-body">
        <a href="/blog/envoy-wasm/">
          <h5 class="mt-0">Istio 进阶学习系列 - 基于 WebAssembly 实现 Envoy 与 Istio 的功能扩展</h5>
        </a>
        2020年6月12日
      </div>
    </div>
    
    <div class="media border-bottom border-color pb-3 mb-3">
      <a href="/blog/etcd-1/"><img class="mr-3 post-thumb-sm" src="/images/etcd-covers.png"></a>
      <div class="media-body">
        <a href="/blog/etcd-1/">
          <h5 class="mt-0">彻底搞懂 etcd 系列文章（一）：初识 etcd</h5>
        </a>
        2020年6月9日
      </div>
    </div>
    
  </div>

  <!-- profile -->

  <!-- categories -->
  <div class="bg-white px-4 py-5 box-shadow mb-5">
    <h4 class="mb-4">类别</h4>
    <ul class="list-styled style-circle">
      <li class="border-bottom border-color"><a href="/categories/cloud-native" class="text-color d-block pb-3 mt-3 text-decoration-none">Cloud native</a></li>
      <li class="border-bottom border-color"><a href="/categories/devops" class="text-color d-block pb-3 mt-3 text-decoration-none">Devops</a></li>
      <li class="border-bottom border-color"><a href="/categories/etcd" class="text-color d-block pb-3 mt-3 text-decoration-none">Etcd</a></li>
      <li class="border-bottom border-color"><a href="/categories/istio" class="text-color d-block pb-3 mt-3 text-decoration-none">Istio</a></li>
      <li class="border-bottom border-color"><a href="/categories/kubernetes" class="text-color d-block pb-3 mt-3 text-decoration-none">Kubernetes</a></li>
      <li class="border-bottom border-color"><a href="/categories/oam" class="text-color d-block pb-3 mt-3 text-decoration-none">Oam</a></li>
      <li class="border-bottom border-color"><a href="/categories/operator" class="text-color d-block pb-3 mt-3 text-decoration-none">Operator</a></li>
      <li class="border-bottom border-color"><a href="/categories/programming" class="text-color d-block pb-3 mt-3 text-decoration-none">Programming</a></li>
      <li class="border-bottom border-color"><a href="/categories/service-mesh" class="text-color d-block pb-3 mt-3 text-decoration-none">Service mesh</a></li>
      <li class="border-bottom border-color"><a href="/categories/%e5%85%b6%e4%bb%96" class="text-color d-block pb-3 mt-3 text-decoration-none">其他</a></li>
      <li class="border-bottom border-color"><a href="/categories/%e5%bc%80%e6%ba%90" class="text-color d-block pb-3 mt-3 text-decoration-none">开源</a></li>
      <li class="border-bottom border-color"><a href="/categories/%e6%8c%87%e5%8d%97" class="text-color d-block pb-3 mt-3 text-decoration-none">指南</a></li>
    </ul>
  </div>
  <!-- tags -->
  <div class="bg-white px-4 py-5 box-shadow mb-5">
    <h4 class="mb-4">标签</h4>
    <ul class="list-inline tag-list">
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/cicd">Cicd</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/cloud-native">Cloud native</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/crossplane">Crossplane</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/envoy">Envoy</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/etcd">Etcd</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/flamegraph">Flamegraph</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/istio">Istio</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/kubernetes">Kubernetes</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/microservices">Microservices</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/oam">Oam</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/operator">Operator</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/profile">Profile</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/service-mesh">Service mesh</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/spring-cloud">Spring cloud</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/tcpdump">Tcpdump</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/tekton">Tekton</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/vxlan">Vxlan</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/wasm">Wasm</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/wireshark">Wireshark</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/zookeeper">Zookeeper</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/%e5%bc%80%e6%ba%90">开源</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/%e6%8a%95%e7%a8%bf">投稿</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/%e7%a4%be%e5%8c%ba">社区</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/%e9%a3%8e%e6%a0%bc">风格</a></li>
    </ul>
  </div>
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#导言">导言</a></li>
<li><a href="#功能需求">功能需求</a></li>
<li><a href="#crd">CRD</a></li>
<li><a href="#架构图">架构图</a></li>
<li><a href="#具体方案">具体方案</a>
<ul>
<li><a href="#快速部署">快速部署</a>
<ul>
<li><a href="#基本知识">基本知识</a></li>
<li><a href="#labels">Labels</a></li>
<li><a href="#节点部署">节点部署</a>
<ul>
<li><a href="#容器分类">容器分类</a></li>
<li><a href="#初始化容器">初始化容器</a></li>
<li><a href="#主进程容器">主进程容器</a></li>
<li><a href="#监控容器">监控容器</a></li>
<li><a href="#访问控制">访问控制</a></li>
<li><a href="#配置信息">配置信息</a></li>
<li><a href="#数据存储">数据存储</a></li>
</ul></li>
</ul></li>
<li><a href="#自动化监控">自动化监控</a>
<ul>
<li><a href="#监控注册">监控注册</a>
<ul>
<li><a href="#servicemonitor">ServiceMonitor</a></li>
<li><a href="#prometheusrule">PrometheusRule</a></li>
</ul></li>
</ul></li>
<li><a href="#安全伸缩容">安全伸缩容</a>
<ul>
<li><a href="#扩缩节点">扩缩节点</a></li>
<li><a href="#扩资源">扩资源</a></li>
</ul></li>
<li><a href="#故障自愈">故障自愈</a>
<ul>
<li><a href="#observer">Observer</a></li>
<li><a href="#触发主流程">触发主流程</a></li>
</ul></li>
<li><a href="#可视化操作">可视化操作</a>
<ul>
<li><a href="#多kubernetes环境">多kubernetes环境</a></li>
<li><a href="#接口列表">接口列表</a></li>
</ul></li>
<li><a href="#参数校验">参数校验</a>
<ul>
<li><a href="#admission-webhooks">Admission Webhooks</a></li>
</ul></li>
<li><a href="#升级策略">升级策略</a>
<ul>
<li><a href="#ondelete的一般方法">OnDelete的一般方法</a></li>
<li><a href="#rollingupdate-partition-方法">RollingUpdate.Partition 方法</a></li>
</ul></li>
<li><a href="#agent">Agent</a>
<ul>
<li><a href="#接口列表-1">接口列表</a></li>
<li><a href="#get">GET</a></li>
<li><a href="#post">POST</a></li>
</ul></li>
</ul></li>
<li><a href="#oam对接">OAM对接</a>
<ul>
<li><a href="#应用组件-components">应用组件（Components）</a></li>
<li><a href="#应用运维特征-traits">应用运维特征（Traits）</a></li>
</ul></li>
<li><a href="#小结">小结</a></li>
<li><a href="#参考文档">参考文档</a></li>
</ul></li>
</ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="Cloud Native Community" width="60%"></a>
          <p class="text-light mb-5">云原生社区是一个有技术、有温度、有情怀的开源社区。它由一群热爱开源的行业精英自发成立，秉持“共识、共治、共建、共享”的原则服务于全球华人。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativeto"><i class="fa fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fa fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="/contact"><i class="fa fa-wechat"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="fa fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fa fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3">北京 · 上海 · 成都 · 伦敦 · 旧金山</p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="356px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright &copy; 2020 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/code-of-conduct"
                class="text-white">社区守则</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>



<script>
  var indexURL = "/index.json"
</script>


<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '5bad3ecca604fe041dd79b5236020563',
    indexName: 'DocSearch',
    appId: 'G3FZ18C6OT',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>

</body>

</html>