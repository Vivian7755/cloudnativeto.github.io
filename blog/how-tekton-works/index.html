<!DOCTYPE html>

<html lang="zh-cn"><head>
  <meta charset="utf-8">
  <title>Tekton 的工作原理 | 云原生社区</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="结合源码和场景分析 Tekton 的工作原理。">
  
  <meta name="author" content="Cloud Native Community">
  <meta name="generator" content="Hugo 0.55.5" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/plugins/slick/slick.css">
  
  <link rel="stylesheet" href="/plugins/fontawesome/font-awesome.min.css">
  
  <link rel="stylesheet" href="/plugins/animate/animate.css">
  
  <link rel="stylesheet" href="/plugins/venobox/venobox.css">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/images/favicon.png " type="image/x-icon">

  <!--Algolia-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css">
</head>
<body>
<!-- header -->
<header>
  

  <!-- navigation -->
  <div class="navigation bg-white position-relative">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <a class="navbar-brand" href="/"><img class="img-fluid pb-lg-3" src="/images/logo.png" width="189px" alt="Cloud Native Community"></a>
        <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navigation">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/"></a>
            </li>
            
            
            <li class="nav-item">
              <a class="nav-link" href="/about">关于</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/blog">博客</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/team">团队</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contact">联系</a>
            </li>
            
            
            
            <li class="nav-item">
              <a class="nav-link" href="/contribute">投稿</a>
            </li>
            
            
          </ul>

          
          

          
          <!-- search -->
          <div class="search px-4">
            <button id="searchOpen" class="search-btn"><i class="fa fa-search text-dark"></i></button>
            <div class="search-wrapper">
              <form action="/search">
                <input class="search-box form-control" id="js-algolia-btn" name="s" type="search" placeholder="输入搜索词">
              </form>
              <button id="searchClose" class="search-close"><i class="fa fa-close text-dark"></i></button>
            </div>
          </div>
          
          
          <!-- get start btn -->
          <a href="/contact" class="btn btn-primary hover-ripple">加入我们</a>
          
        </div>
      </nav>
    </div>
  </div>
  <!-- /navigation -->
</header>
<!-- /header -->


<!-- page title -->
<section class="section bg-cover overlay" style="background-image: url('/'),url('/'),url('/images/backgrounds/page-title.jpg');">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <h2 class="text-white mb-3">Tekton 的工作原理</h2>
        <!-- breadcrumb -->
        
        <p class="text-white">结合源码和场景分析 Tekton 的工作原理。</p>
      </div>
    </div>
  </div>
</section>
<!-- /page title -->


<!-- blog details -->
<section class="section">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <!-- post thumb -->
        <div class="position-relative mb-5">
          <img src="/"  onerror="this.src='https:\/\/gw.alipayobjects.com\/mdn\/rms_95b965\/afts\/img\/A*eUqkTKk66gkAAAAAAAAAAABkARQnAQ'" alt="post thumb" class="img-fluid w-100">
           <div class="card-type">DevOps</div>
        </div>
        <div class="card-meta text-uppercase mb-2">作者  <strong class="text-dark"><a href="https://atbug.com">张晓辉</a></strong>
          
            发表于 <strong class="text-dark">2020年5月23日</strong></div>
        <hr>
        <div class="content">
          

<p><strong>这篇文章是基于 Tekton Pipeline 的最新版本<code>v0.12.1</code>版本。</strong></p>

<p>快速入门请参考：<a href="https://atbug.com/tekton-trigger-practice/">云原生 CICD: Tekton Pipeline 实战</a> ，实战是基于版本 v0.10.x。</p>

<h2 id="pipeline-crd-与核心资源的关系">Pipeline CRD 与核心资源的关系</h2>

<pre><code class="language-shell">$ k api-resources --api-group=tekton.dev
NAME                SHORTNAMES   APIGROUP     NAMESPACED   KIND
clustertasks                     tekton.dev   false        ClusterTask
conditions                       tekton.dev   true         Condition
pipelineresources                tekton.dev   true         PipelineResource
pipelineruns        pr,prs       tekton.dev   true         PipelineRun
pipelines                        tekton.dev   true         Pipeline
taskruns            tr,trs       tekton.dev   true         TaskRun
tasks                            tekton.dev   true         Task
</code></pre>

<p>Tekton Pipelines提供了上面的CRD，其中部分CRD与Kubernetes core中资源相对应</p>

<ul>
<li>Task =&gt; Pod</li>
<li>Task.Step =&gt; Container</li>
</ul>

<p><img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902164552270.jpg" alt="" /></p>

<h2 id="工作原理">工作原理</h2>

<p><img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902280074872.jpg" alt="" />
(图片来自tekton.dev)</p>

<p>Tekton Pipeline 是基于 Knative 的实现，pod <code>tekton-pipelines-controller</code> 中有两个 <a href="https://knative.dev/docs/eventing/samples/writing-receive-adapter-source/03-controller/">Knative Controller</a>的实现：PipelineRun 和 TaskRun。</p>

<p><img src="https://atbug.oss-cn-hangzhou.aliyuncs.com/2020/05/23/15902270934199.jpg" alt="" /></p>

<h3 id="task的执行顺序">Task的执行顺序</h3>

<p>PipelineRun Controller 的 <code>#reconcile()</code>方法，监控到有<code>PipelineRun</code>被创建。然后从<code>PipelineSpec</code>的 tasks 列表，构建出一个图（<code>graph</code>），用于描述<code>Pipeline</code>中 Task 间的依赖关系。依赖关系是通过<code>runAfter</code>和<code>from</code>，进而控制<a href="#Task的执行顺序">Task的执行顺序</a>。与此同时，准备<code>PipelineRun</code>中定义的<code>PipelineResources</code>。</p>

<pre><code class="language-go">// Node represents a Task in a pipeline.
type Node struct {
	// Task represent the PipelineTask in Pipeline
	Task Task
	// Prev represent all the Previous task Nodes for the current Task
	Prev []*Node
	// Next represent all the Next task Nodes for the current Task
	Next []*Node
}

// Graph represents the Pipeline Graph
type Graph struct {
	//Nodes represent map of PipelineTask name to Node in Pipeline Graph
	Nodes map[string]*Node
}

func Build(tasks Tasks) (*Graph, error) {
    ...
}
</code></pre>

<p><code>PipelineRun</code>中定义的参数（parameters）也会注入到<code>PipelineSpec</code>中：</p>

<pre><code class="language-go">pipelineSpec = resources.ApplyParameters(pipelineSpec, pr)
</code></pre>

<p>接下来就是调用<code>dag#GetSchedulable()</code>方法，获取未完成（通过Task状态判断）的 Task 列表；</p>

<pre><code class="language-go">func GetSchedulable(g *Graph, doneTasks ...string) (map[string]struct{}, error) {
    ...
}
</code></pre>

<p>为 Task A 创建<code>TaskRun</code>，假如<code>Task</code>配置了<code>Condition</code>。会先为 condition创建一个<code>TaskRun</code>，只有在 condition 的<code>TaskRun</code>运行成功，才会运行 A 的<code>TaskRun</code>；否则就跳过。</p>

<h3 id="step的执行顺序">Step的执行顺序</h3>

<p>这一部分篇幅较长，之前的文章 <a href="https://atbug.com/control-process-order-of-pod-containers/">控制 Pod 内容器的启动顺序</a> 中提到过。</p>

<p>这里补充一下<a href="https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#the-downward-api">Kubernetes Downward API</a>的使用，Kubernetes Downward API的引入，控制着 <code>Task</code> 的第一个 <code>Step</code> 在何时执行。</p>

<p><code>TaskRun</code> Controller 在 reconciling 的过程中，在相应的 <code>Pod</code> 状态变为<code>Running</code>时，会将<code>tekton.dev/ready=READY</code>写入到 Pod 的 annotation 中，来通知第一个<code>Step</code>的执行。</p>

<p>Pod的部分内容：</p>

<pre><code class="language-yaml">spec:
  containers:
    - args:
      - -wait_file
      - /tekton/downward/ready
      - -wait_file_content
      - -post_file
      - /tekton/tools/0
      - -termination_path
      - /tekton/termination
      - -entrypoint
      - /ko-app/git-init
      - --
      - -url
      - ssh://git@gitlab.nip.io:8022/addozhang/logan-pulse.git
      - -revision
      - develop
      - -path
      - /workspace/git-source
      command:
      - /tekton/tools/entrypoint
      volumeMounts:
      - mountPath: /tekton/downward
        name: tekton-internal-downward
      
  volumes:
    - downwardAPI:
        defaultMode: 420
        items:
        - fieldRef:
            apiVersion: v1
            fieldPath: metadata.annotations['tekton.dev/ready']
          path: ready
      name: tekton-internal-downward
</code></pre>

<p>对原生的排序step container进一步处理：启动命令使用<code>entrypoint</code>提供，并设置执行参数：</p>

<p><code>entrypoint.go</code></p>

<pre><code class="language-go">func orderContainers(entrypointImage string, steps []corev1.Container, results []v1alpha1.TaskResult) (corev1.Container, []corev1.Container, error) {
	initContainer := corev1.Container{
		Name:         &quot;place-tools&quot;,
		Image:        entrypointImage,
		Command:      []string{&quot;cp&quot;, &quot;/ko-app/entrypoint&quot;, entrypointBinary},
		VolumeMounts: []corev1.VolumeMount{toolsMount},
	}

	if len(steps) == 0 {
		return corev1.Container{}, nil, errors.New(&quot;No steps specified&quot;)
	}

	for i, s := range steps {
		var argsForEntrypoint []string
		switch i {
		case 0:
			argsForEntrypoint = []string{
				// First step waits for the Downward volume file.
				&quot;-wait_file&quot;, filepath.Join(downwardMountPoint, downwardMountReadyFile),
				&quot;-wait_file_content&quot;, // Wait for file contents, not just an empty file.
				// Start next step.
				&quot;-post_file&quot;, filepath.Join(mountPoint, fmt.Sprintf(&quot;%d&quot;, i)),
				&quot;-termination_path&quot;, terminationPath,
			}
		default:
			// All other steps wait for previous file, write next file.
			argsForEntrypoint = []string{
				&quot;-wait_file&quot;, filepath.Join(mountPoint, fmt.Sprintf(&quot;%d&quot;, i-1)),
				&quot;-post_file&quot;, filepath.Join(mountPoint, fmt.Sprintf(&quot;%d&quot;, i)),
				&quot;-termination_path&quot;, terminationPath,
			}
		}
    ...
}
</code></pre>

<h3 id="自动运行的容器">自动运行的容器</h3>

<p>这些自动运行的容器作为 pod 的<code>initContainer</code>会在 step 容器运行之前运行</p>

<h4 id="credential-initializer"><code>credential-initializer</code></h4>

<p>用于将 <code>ServiceAccount</code> 的相关secrets持久化到容器的文件系统中。比如 ssh 相关秘钥、config文件以及know_hosts文件；docker registry 相关的凭证则会被写入到 docker 的配置文件中。</p>

<h4 id="working-dir-initializer"><code>working-dir-initializer</code></h4>

<p>收集<code>Task</code>内的各个<code>Step</code>的<code>workingDir</code>配置，初始化目录结构</p>

<h4 id="place-scripts"><code>place-scripts</code></h4>

<p>假如<code>Step</code>使用的是<code>script</code>配置（与command+args相对），这个容器会将脚本代码（<code>script</code>字段的内容）持久化到<code>/tekton/scripts</code>目录中。</p>

<p>注：所有的脚本会自动加上<code>#!/bin/sh\nset -xe\n</code>，所以<code>script</code>字段里就不必写了。</p>

<h4 id="place-tools"><code>place-tools</code></h4>

<p>将<code>entrypoint</code>的二进制文件，复制到<code>/tekton/tools/entrypoint</code>.</p>

<h3 id="task-step间的数据传递">Task/Step间的数据传递</h3>

<p>针对不同的数据，有多种不同的选择。比如<code>Workspace</code>、<code>Result</code>、<code>PipelineResource</code>。对于由于<code>Task</code>的执行是通过<code>Pod</code>来完成的，而<code>Pod</code>会调度到不同的节点上。因此<code>Task</code>间的数据传递，需要用到持久化的卷。</p>

<p>而<code>Step</code>作为<code>Pod</code>中的容器来运行，</p>

<h4 id="workspace">Workspace</h4>

<p>工作区，可以理解为一个挂在到容器上的卷，用于文件的传递。</p>

<h5 id="persistentvolumeclaim"><code>persistentVolumeClaim</code></h5>

<p>引用已存在<code>persistentVolumeClaim</code>卷（volume）。这种工作空间，可多次使用，需要先进行创建。比如 Java 项目的 <code>maven</code>，编译需要本地依赖库，这样可以节省每次编译都要下载依赖包的成本。</p>

<pre><code class="language-yaml">workspaces:
- name: m2
  persistentVolumeClaim:
    claimName: m2-pv-claim
</code></pre>

<pre><code class="language-yaml">apiVersion: v1
kind: PersistentVolume
metadata:
  name: m2-pv
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: &quot;/data/.m2&quot;
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: m2-pv-claim
spec:
  storageClassName: manual
  # volumeName: m2-pv
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
</code></pre>

<h5 id="volumeclaimtemplate"><code>volumeClaimTemplate</code></h5>

<p>为每个<code>PipelineRun</code>或者<code>TaskRun</code>创建<code>PersistentVolumeClaim</code>卷（volume）的模板。比如一次构建需要从 git 仓库克隆代码，而针对不同的流水线代码仓库是不同的。这里就会用到<code>volumeClaimTemplate</code>，为每次构建创建一个<code>PersistentVolumeClaim</code>卷。（从0.12.0开始）</p>

<p>生命周期同<code>PipelineRun</code>或者<code>TaskRun</code>，运行之后释放。</p>

<pre><code class="language-yaml">workspaces:
- name: git-source
  volumeClaimTemplate:
    spec:
      accessModes:
      - ReadWriteMany
      resources:
        requests:
          storage: 1Gi
</code></pre>

<p>相较于<code>persistantVolumeClain</code>类型的workspace，<code>volumeClaimTemplate</code>不需要在每次在<code>PipelineRun</code>完成后清理工作区；并发情况下可能会出现问题。</p>

<h5 id="emptydir"><code>emptyDir</code></h5>

<p>引用<code>emptyDir</code>卷，跟随<code>Task</code>生命周期的临时目录。适合在<code>Task</code>的<code>Step</code>间共享数据，无法在多个<code>Task</code>间共享。</p>

<pre><code class="language-yaml">workspaces:
- name: temp
  emptyDir: {}
</code></pre>

<h5 id="configmap"><code>configMap</code></h5>

<p>引用一个<code>configMap</code>卷，将<code>configMap</code>卷作为工作区，有如下限制：</p>

<ul>
<li>挂载的卷是<code>只读</code>的</li>
<li>需要提前创建<code>configMap</code></li>
<li><code>configMap</code>的<a href="https://github.com/kubernetes/kubernetes/blob/f16bfb069a22241a5501f6fe530f5d4e2a82cf0e/pkg/apis/core/validation/validation.go#L5042">大小限制为1MB（Kubernetes的限制）</a></li>
</ul>

<p>使用场景，比如使用<code>maven</code>编译Java项目，配置文件<code>settings.xml</code>可以使用<code>configMap</code>作为工作区</p>

<pre><code class="language-yaml">workspaces:
- name: maven-settings
  configmap:
    name: maven-settings
</code></pre>

<h5 id="secret"><code>secret</code></h5>

<p>用于引用<code>secret</code>卷，同<code>configMap</code>工作区一样，也有限制：</p>

<ul>
<li>挂载的卷是<code>只读</code>的</li>
<li>需要提前创建<code>secret</code></li>
<li><code>secret</code>的<a href="https://github.com/kubernetes/kubernetes/blob/f16bfb069a22241a5501f6fe530f5d4e2a82cf0e/pkg/apis/core/validation/validation.go#L5042">大小限制为1MB（Kubernetes的限制）</a></li>
</ul>

<h4 id="results"><code>results</code></h4>

<p><code>results</code>字段可以用来配置多个文件用来存储<code>Tasks</code>的执行结果，这些文件保存在<code>/tekton/results</code>目录中。</p>

<p>在<code>Pipeline</code>中，可以通过<code>tasks.[task-nanme].results.[result-name]</code>注入到其他<code>Task</code>的参数中。</p>

<pre><code class="language-yaml">apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: print-date
  annotations:
    description: |
      A simple task that prints the date
spec:
  results:
    - name: current-date-unix-timestamp
      description: The current date in unix timestamp format
    - name: current-date-human-readable
      description: The current date in human readable format
  steps:
    - name: print-date-unix-timestamp
      image: bash:latest
      script: |
        #!/usr/bin/env bash
        date +%s | tee $(results.current-date-unix-timestamp.path)
    - name: print-date-humman-readable
      image: bash:latest
      script: |
        #!/usr/bin/env bash
        date | tee $(results.current-date-human-readable.path)
---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: pass-date
spec:
  pipelineSpec:
    tasks:
      - name: print-date
        taskRef:
          name: print-date
      - name: read-date
        runAfter: #配置执行顺序
          - print-date
        taskSpec:
          params:
            - name: current-date-unix-timestamp
              type: string
            - name: current-date-human-readable
              type: string
          steps:
            - name: read
              image: busybox
              script: |
                echo $(params.current-date-unix-timestamp)
                echo $(params.current-date-human-readable)
        params:
          - name: current-date-unix-timestamp
            value: $(tasks.print-date.results.current-date-unix-timestamp) # 注入参数
          - name: current-date-human-readable
            value: $(tasks.print-date.results.current-date-human-readable) # 注入参数      
</code></pre>

<p>执行结果：</p>

<pre><code class="language-bash">┌──────Logs(tekton-pipelines/pass-date-read-date-rhlf2-pod-9b2sk)[all] ──────────                                                                       │
│ place-scripts stream closed                                                                                                                                                                                                                                                             ││ step-read 1590242170                                                                                                                                                                                                                                                                    │
│ step-read Sat May 23 13:56:10 UTC 2020                                                                                                                                                                                                                                                  ││ step-read + echo 1590242170                                                                                                                                                                                                                                                             │
│ step-read + echo Sat May 23 13:56:10 UTC 2020                                                                                                                                                                                                                                           │
│ place-tools stream closed                                                                                                                                                                                                                                                               │
│ step-read stream closed                                                                                                                                                                                                                                                                 │
│
</code></pre>

<h4 id="pipelineresource">PipelineResource</h4>

<p><code>PipelineResource</code>在最后提，因为目前只是<code>alpha</code>版本，何时会进入<code>beta</code>或者弃用目前还是未知数。有兴趣的可以看下这里：<a href="https://tekton.dev/docs/pipelines/resources/#why-aren-t-pipelineresources-in-beta">Why Aren’t PipelineResources in Beta?</a></p>

<p>简单来说，<code>PipelineResource</code>可以通过其他的方式实现，而其本身也存在弊端：比如实现不透明，debug有难度；功能不够强；降低了Task的重用性等。</p>

<p>比如<code>git</code>类型的<code>PipelineResource</code>，可以通过<code>workspace</code>和<code>git-clone</code> Task来实现；存储类型的，也可以通过<code>workspace</code>来实现。</p>

<p>这也就是为什么<a href="#Workspace">上面介绍workspace的篇幅</a>比较大。个人也偏向于使用<code>workspace</code>，灵活度高；使用workspace的Task重用性强。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="https://atbug.com/tekton-trigger-practice">云原生 CICD: Tekton Pipeline 实战</a></li>
<li><a href="https://atbug.com/control-process-order-of-pod-containers">控制 Pod 内容器的启动顺序</a></li>
<li><a href="https://knative.dev/docs/eventing/samples/writing-receive-adapter-source/03-controller">Knative Controller</a></li>
<li><a href="https://tekton.dev/docs/pipelines/resources/#why-aren-t-pipelineresources-in-beta">Why Aren’t PipelineResources in Beta?</a></li>
</ul>

        </div>
        <!-- tags -->
        <div class="mb-3">
          <h5 class="d-inline-block mr-3">Tags:</h5>
          <ul class="list-inline d-inline-block">
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/tekton"> 
            Tekton</a>
            <a>
            <li class="list-inline-item"><a class="text-color" href="/tags/cicd"> , 
            CICD</a>
            
          </ul>
        </div>
        
        
        <div id="gitalk-container"></div>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
          const gitalk = new Gitalk({
            clientID: '0f001988910adcfadfb7',
            clientSecret: '14f7d06ee5e6575c295d18fc11616e8cb60fb84e',
            repo: 'cloudnativeto.github.io',
            owner: 'cloudnativeto',
            admin: ['rootsongjc'],
            id: hex_md5(hex_md5(window.location.pathname + window.location.hash)), 
            distractionFreeMode: false 
          });
          (function() {
            if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
              document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
              return;
            }
            gitalk.render('gitalk-container');
          })();
        </script>
        
      </div>
      <!-- sidebar -->
<aside class="col-lg-4 order-1 order-lg-2">
  <!-- latest post -->
  <div class="bg-white px-4 py-5 box-shadow mb-5">
    <h4 class="mb-4">最新文章</h4>
    <!-- post-item -->
    
    <div class="media border-bottom border-color pb-3 mb-3">
      <a href="/blog/flame-graph/"><img class="mr-3 post-thumb-sm" src="/images/blog/flamegraph.png"></a>
      <div class="media-body">
        <a href="/blog/flame-graph/">
          <h5 class="mt-0">性能调优利器--火焰图</h5>
        </a>
        2020年6月17日
      </div>
    </div>
    
    <div class="media border-bottom border-color pb-3 mb-3">
      <a href="/blog/envoy-wasm/"><img class="mr-3 post-thumb-sm" src="/images/blog/envoy-wasm.png"></a>
      <div class="media-body">
        <a href="/blog/envoy-wasm/">
          <h5 class="mt-0">Istio 进阶学习系列 - 基于 WebAssembly 实现 Envoy 与 Istio 的功能扩展</h5>
        </a>
        2020年6月12日
      </div>
    </div>
    
    <div class="media border-bottom border-color pb-3 mb-3">
      <a href="/blog/etcd-1/"><img class="mr-3 post-thumb-sm" src="/images/etcd-covers.png"></a>
      <div class="media-body">
        <a href="/blog/etcd-1/">
          <h5 class="mt-0">彻底搞懂 etcd 系列文章（一）：初识 etcd</h5>
        </a>
        2020年6月9日
      </div>
    </div>
    
  </div>

  <!-- profile -->
  <div class="bg-pink px-4 py-5 box-shadow mb-5 avatar-content">
    <div class="avatar">
      <p class="avatar-name">
        <strong class="text-dark "><a href="https://atbug.com">张晓辉</a></strong> 
      </p>
      <p>资深码农，12 年软件开发经验。曾在汇丰软件、唯品会、数人云等公司任职。目前就职小鹏汽车，在基础架构团队从事技术中台的研发。</p>
    </div>
  </div>

  <!-- categories -->
  <div class="bg-white px-4 py-5 box-shadow mb-5">
    <h4 class="mb-4">类别</h4>
    <ul class="list-styled style-circle">
      <li class="border-bottom border-color"><a href="/categories/cloud-native" class="text-color d-block pb-3 mt-3 text-decoration-none">Cloud native</a></li>
      <li class="border-bottom border-color"><a href="/categories/devops" class="text-color d-block pb-3 mt-3 text-decoration-none">Devops</a></li>
      <li class="border-bottom border-color"><a href="/categories/etcd" class="text-color d-block pb-3 mt-3 text-decoration-none">Etcd</a></li>
      <li class="border-bottom border-color"><a href="/categories/istio" class="text-color d-block pb-3 mt-3 text-decoration-none">Istio</a></li>
      <li class="border-bottom border-color"><a href="/categories/kubernetes" class="text-color d-block pb-3 mt-3 text-decoration-none">Kubernetes</a></li>
      <li class="border-bottom border-color"><a href="/categories/oam" class="text-color d-block pb-3 mt-3 text-decoration-none">Oam</a></li>
      <li class="border-bottom border-color"><a href="/categories/operator" class="text-color d-block pb-3 mt-3 text-decoration-none">Operator</a></li>
      <li class="border-bottom border-color"><a href="/categories/programming" class="text-color d-block pb-3 mt-3 text-decoration-none">Programming</a></li>
      <li class="border-bottom border-color"><a href="/categories/service-mesh" class="text-color d-block pb-3 mt-3 text-decoration-none">Service mesh</a></li>
      <li class="border-bottom border-color"><a href="/categories/%e5%85%b6%e4%bb%96" class="text-color d-block pb-3 mt-3 text-decoration-none">其他</a></li>
      <li class="border-bottom border-color"><a href="/categories/%e5%bc%80%e6%ba%90" class="text-color d-block pb-3 mt-3 text-decoration-none">开源</a></li>
      <li class="border-bottom border-color"><a href="/categories/%e6%8c%87%e5%8d%97" class="text-color d-block pb-3 mt-3 text-decoration-none">指南</a></li>
    </ul>
  </div>
  <!-- tags -->
  <div class="bg-white px-4 py-5 box-shadow mb-5">
    <h4 class="mb-4">标签</h4>
    <ul class="list-inline tag-list">
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/cicd">Cicd</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/cloud-native">Cloud native</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/crossplane">Crossplane</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/envoy">Envoy</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/etcd">Etcd</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/flamegraph">Flamegraph</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/istio">Istio</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/kubernetes">Kubernetes</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/microservices">Microservices</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/oam">Oam</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/operator">Operator</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/profile">Profile</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/service-mesh">Service mesh</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/spring-cloud">Spring cloud</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/tcpdump">Tcpdump</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/tekton">Tekton</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/vxlan">Vxlan</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/wasm">Wasm</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/wireshark">Wireshark</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/zookeeper">Zookeeper</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/%e5%bc%80%e6%ba%90">开源</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/%e6%8a%95%e7%a8%bf">投稿</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/%e7%a4%be%e5%8c%ba">社区</a></li>
      <li class="list-inline-item"><a class="hover-ripple" href="/tags/%e9%a3%8e%e6%a0%bc">风格</a></li>
    </ul>
  </div>
  <!-- toc -->
  
  <div class="bg-white px-4 py-5 box-shadow mb-5 sticky-top">
    <h4 class="mb-4">目录</h4>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#pipeline-crd-与核心资源的关系">Pipeline CRD 与核心资源的关系</a></li>
<li><a href="#工作原理">工作原理</a>
<ul>
<li><a href="#task的执行顺序">Task的执行顺序</a></li>
<li><a href="#step的执行顺序">Step的执行顺序</a></li>
<li><a href="#自动运行的容器">自动运行的容器</a>
<ul>
<li><a href="#credential-initializer"><code>credential-initializer</code></a></li>
<li><a href="#working-dir-initializer"><code>working-dir-initializer</code></a></li>
<li><a href="#place-scripts"><code>place-scripts</code></a></li>
<li><a href="#place-tools"><code>place-tools</code></a></li>
</ul></li>
<li><a href="#task-step间的数据传递">Task/Step间的数据传递</a>
<ul>
<li><a href="#workspace">Workspace</a>
<ul>
<li><a href="#persistentvolumeclaim"><code>persistentVolumeClaim</code></a></li>
<li><a href="#volumeclaimtemplate"><code>volumeClaimTemplate</code></a></li>
<li><a href="#emptydir"><code>emptyDir</code></a></li>
<li><a href="#configmap"><code>configMap</code></a></li>
<li><a href="#secret"><code>secret</code></a></li>
</ul></li>
<li><a href="#results"><code>results</code></a></li>
<li><a href="#pipelineresource">PipelineResource</a></li>
</ul></li>
</ul></li>
<li><a href="#参考">参考</a></li>
</ul></li>
</ul>
</nav>
  </div>

</aside>
<!-- /sidebar -->

    </div>
  </div>
</section>
<!-- /blog details -->



<footer>
  
  <div class="section bg-secondary">
    <div class="container">
      <div class="row justify-content-between">
        
        <div class="col-lg-5 mb-5 mb-lg-0">
          
          <a class="mb-4 d-inline-block" href="/"><img class="img-fluid"
              src="/images/logo-alt.png" alt="Cloud Native Community" width="60%"></a>
          <p class="text-light mb-5">云原生社区是一个有技术、有温度、有情怀的开源社区。它由一群热爱开源的行业精英自发成立，秉持“共识、共治、共建、共享”的原则服务于全球华人。</p>
          <h4 class="text-white mb-4">关注我们</h4>
          
          <ul class="list-inline social-icon-alt">
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://twitter.com/cloudnativeto"><i class="fa fa-twitter"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://github.com/cloudnativeto"><i class="fa fa-github"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="/contact"><i class="fa fa-wechat"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="mailto:contact@cloudnative.to"><i class="fa fa-envelope"></i></a>
            </li>
            
            <li class="list-inline-item">
              <a class="hover-ripple" href="https://cloudnative.to/blog/index.xml"><i class="fa fa-rss"></i></a>
            </li>
            
          </ul>
        </div>
        <div class="col-lg-5 mb-5 mb-lg-0">
            
            
            
            
            
            <div class="mb-5">
              <h4 class="text-white mb-4">联系信息</h4>
              <p class="text-light mb-3">北京 · 上海 · 成都 · 伦敦 · 旧金山</p>
              <p class="text-light mb-3"></p>
              <p class="text-light mb-3">关注云原生社区微信公众号，加入社区并获取最新资讯。</p>
              <p class="text-light mb-3"><img src="/images/wechat-qrcode.png" width="356px"></p>
            </div>
            
            
        </div>
      </div>
    </div>
  </div>
  
  <div class="bg-secondary-darken py-4">
    <div class="container">
      <div class="row">
        <div class="col-md-6 text-center text-md-left mb-3 mb-md-0">
          <p class="mb-0 text-white">Copyright &copy; 2020 云原生社区</p>
        </div>
        <div class="col-md-6 text-center text-md-right">
          <ul class="list-inline">
            
            <li class="list-inline-item mx-0"><a class="d-inline-block px-3 text-white" href="/code-of-conduct"
                class="text-white">社区守则</a></li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</footer>



<script>
  var indexURL = "/index.json"
</script>


<!-- JS Plugins -->

<script src="/plugins/jQuery/jquery.min.js"></script>

<script src="/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/plugins/slick/slick.min.js"></script>

<script src="/plugins/google-map/gmap.js"></script>

<script src="/plugins/venobox/venobox.min.js"></script>

<script src="/plugins/filterizr/jquery.filterizr.min.js"></script>

<script src="/plugins/search/fuse.min.js"></script>

<script src="/plugins/search/mark.js"></script>

<script src="/plugins/search/search.js"></script>


<!-- Main Script -->

<script src="/js/script.min.js"></script>

<!-- Algolia -->
<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js"></script>
<script>
  docsearch({
    apiKey: '270c30136e5b8d67acdcf6436541543b',
    indexName: 'DocSearch',
    appId: '2506Q6I4IV',
    inputSelector: '#js-algolia-btn',
    debug: false,
  });
</script>

<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-93485976-4', 'auto');
  ga('send', 'pageview');
</script>

</body>

</html>